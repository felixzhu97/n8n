@startuml
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho
title n8n 数据架构图 (Data Architecture)

package "核心数据模型 (Core Data Models)" {
  component [WorkflowEntity] as WorkflowEntity
  component [ExecutionEntity] as ExecutionEntity
  component [ExecutionData] as ExecutionData
  component [CredentialsEntity] as CredentialsEntity
  component [User] as User
  component [Project] as Project
  component [Folder] as Folder
  component [TagEntity] as TagEntity
}

package "关联数据模型 (Related Data Models)" {
  component [SharedWorkflow] as SharedWorkflow
  component [SharedCredentials] as SharedCredentials
  component [WorkflowHistory] as WorkflowHistory
  component [WebhookEntity] as WebhookEntity
  component [BinaryDataFile] as BinaryDataFile
}

package "数据流视图 (Data Flow View)" {
  component [工作流设计数据流] as DesignFlow
  component [工作流执行数据流] as ExecutionFlow
  component [凭证数据流] as CredentialFlow
  component [二进制数据流] as BinaryFlow
}

package "数据存储视图 (Data Storage View)" {
  database [SQLite] as SQLite
  database [PostgreSQL] as PostgreSQL
  database [MySQL] as MySQL
  database [Redis] as Redis
  component [文件存储] as FileStorage
}

package "数据访问层 (Data Access Layer)" {
  component [TypeORM] as TypeORM
  component [Repository Pattern] as Repository
}

' 关系定义
WorkflowEntity --> ExecutionEntity
WorkflowEntity --> WorkflowHistory
WorkflowEntity --> SharedWorkflow
WorkflowEntity --> TagEntity

ExecutionEntity --> ExecutionData

CredentialsEntity --> SharedCredentials

User --> SharedWorkflow
User --> SharedCredentials
User --> Project

Project --> WorkflowEntity
Folder --> WorkflowEntity

DesignFlow --> WorkflowEntity
ExecutionFlow --> WorkflowEntity
ExecutionFlow --> ExecutionEntity
ExecutionFlow --> ExecutionData
CredentialFlow --> CredentialsEntity
BinaryFlow --> BinaryDataFile

TypeORM --> SQLite
TypeORM --> PostgreSQL
TypeORM --> MySQL
Repository --> TypeORM

WorkflowEntity --> SQLite
WorkflowEntity --> PostgreSQL
ExecutionEntity --> SQLite
ExecutionEntity --> PostgreSQL
CredentialsEntity --> SQLite
CredentialsEntity --> PostgreSQL
BinaryDataFile --> FileStorage

ExecutionFlow --> Redis
CredentialFlow --> Redis

note right of WorkflowEntity
  工作流实体：
  - id: string
  - name: string
  - description: string
  - active: boolean
  - nodes: INode[]
  - connections: IConnections
  - versionId: string
  存储工作流的完整定义
end note

note right of ExecutionEntity
  执行实体：
  - id: string
  - workflowId: string
  - mode: string
  - startedAt: Date
  - stoppedAt: Date
  - finished: boolean
  存储工作流执行的历史记录
end note

note right of ExecutionData
  执行数据实体：
  - executionId: string
  - workflowData: string
  - data: string
  存储执行过程中的详细数据
end note

note right of CredentialsEntity
  凭证实体：
  - id: string
  - name: string
  - type: string
  - data: string (encrypted)
  加密存储的认证凭证信息
end note

note right of User
  用户实体：
  - id: string (UUID)
  - email: string
  - firstName: string
  - lastName: string
  - role: Role
  存储用户账户信息
end note

note right of DesignFlow
  设计阶段数据流：
  1. 用户在Editor UI中设计工作流
  2. 前端通过REST API保存工作流
  3. WorkflowEntity存储到数据库
  4. 工作流版本信息记录到WorkflowHistory
end note

note right of ExecutionFlow
  执行阶段数据流：
  1. 触发事件到达
  2. 从数据库加载WorkflowEntity
  3. 创建工作流执行实例
  4. 节点执行产生数据
  5. ExecutionEntity记录执行状态
  6. ExecutionData存储执行数据
end note

note right of CredentialFlow
  凭证数据流：
  1. 用户创建凭证
  2. 凭证数据加密
  3. CredentialsEntity存储加密数据
  4. 执行时凭证解密
  5. 凭证传递给节点使用
end note

note right of BinaryFlow
  二进制数据流：
  1. 节点产生二进制数据
  2. 数据存储到BinaryDataFile
  3. 返回文件引用
  4. 需要时从存储读取
end note

@enduml
